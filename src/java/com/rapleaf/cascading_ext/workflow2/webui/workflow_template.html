<!DOCTYPE html>
<html>
<head>
  <title>${workflow_name} Workflow</title>
  <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
  <link href="css/workflow_diagram.css" rel="stylesheet" media="screen">
</head>
<body>
<div class="container-fluid">
  <div class="row-fluid">
    <div class="span12">
      <div id="canvas" class="canvas"></div>
    </div>
  </div>
  <div class="row-fluid">
    <div class="span4">
      <div id="workflow-controls" class="canvas">
        <a id="expand-all" class="btn btn-info btn-small">Expand All</a>
        <a id="collapse-all" class="btn btn-info btn-small">Collapse All</a>
        <a id="datastores" class="btn btn-info btn-small">Show Datastores</a>
        <a id="shutdown-button" href="#shutdownModal" role="button" class="btn btn-danger btn-small" data-toggle="modal">Shutdown</a>
      </div>
    </div>
    <div class="span3" style="float: right;">
      <div id="legend" class="canvas">
        <div class="legend-entry waiting">waiting</div>
        <div class="legend-entry running">running</div>
        <div class="legend-entry completed">completed</div>
        <div class="legend-entry failed">failed</div>
        <div class="legend-entry skipped">skipped</div>
        <div class="legend-entry datastore">datastore</div>
      </div>
    </div>
  </div>
  <div class="row-fluid">
    <div id="shutdown-reason-area" class="span12 well hide text-error"/>
  </div>
  <div class="row-fluid">
    <div id="details" class="span9 well">
      <div id="step-details" >
        <h3>Process Details</h3>
        <table class="table">
          <tr>
            <th>Name</th>
            <td id="step-details-name">Step 1</td>
          </tr>
          <tr>
            <th>Status</th>
            <td id="step-details-status">NA</td>
          </tr>
          <tr>
            <th>Action</th>
            <td id="step-details-action"><a href="https://git.liveramp.net/MasterRepos/s2s_refresher/blob/master/src/java/com/rapleaf/s2s_refresher/FindOrCreateDataSyncConfig.java">ClassName.java</a></td>
          </tr>
          <tr>
            <th>Dependencies</th>
            <td id="step-details-dependencies">
              <ul> <li>Step 2</li> </ul>
            </td>
          </tr>
          <th>Inputs</th>
          <td id="step-details-inputs">
            <ul> <li>Step 2</li> </ul>
          </td>
          </tr>
          <th>Outputs</th>
          <td id="step-details-outputs">
            <ul> <li>Step 2</li> </ul>
          </td>
          </tr>
        </table>
      </div>

      <div id="ds-details">
        <h3>Datastore Details</h3>
        <table class="table">
          <tr>
            <th>Name</th>
            <td id="ds-details-name">Step 1</td>
          </tr>
          <tr>
            <th>Type</th>
            <td id="ds-details-type">NA</td>
          </tr>
          <tr>
            <th>Path</th>
            <td id="ds-details-path">NA</td>
          </tr>
        </table>
      </div>
    </div>
    <div class="span3">
      <div class="well">
        <div style="overflow: auto; height: 300px">
          <h3>Processes</h3>
          <ul id="process-list" class="nav nav-list">
            <li class='active'><a href="#">Step 1</a></li>
            <li><a href="#">Step 2</a></li>
          </ul>
        </div>
        <div style="overflow: auto; height: 300px">
          <h3>Datastores</h3>
          <ul id="datastore-list" class="nav nav-list">
            <li class='active'>Datastore 1</li>
            <li>Datastore 2</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  <div class="row-fluid">
  </div>
  <div id="shutdownModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="shutdownModalLabel" aria-hidden="true">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
      <h3 id="shutdownModalLabel">Request Shutdown</h3>
    </div>
    <form action="/request_shutdown.jsp" method=post>
      <div class="modal-body">
        <p>Reason for shutdown</p>
        <p><textarea id="shutdown-reason" name="reason" rows="10" style="width:90%"></textarea></p>
      </div>
      <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
        <input type="submit" value="Do it!" class="btn btn-primary"/>
      </div>
    </form>
  </div>
</div>
<script src="js/raphael-min.js" type="text/javascript" charset="utf-8"></script>
<script src="js/diagrams2.js" type="text/javascript" charset="utf-8"></script>
<script src="js/graph.js" type="text/javascript" charset="utf-8"></script>
<script src="js/workflow_diagram.js" type="text/javascript" charset="utf-8"></script>
<script src="js/dag_layout.js" type="text/javascript" charset="utf-8"></script>
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script type="text/javascript">
  function renderProgressBar(pctComplete) {
    if (pctComplete < 0 ) {
      return "<br />";
    }
    return "(" + pctComplete + "%)" +
        "<table style='width: 100px'>"
        + "<tr>"
        + "<td style=\"background-color: #8888ff; width: " + pctComplete + "%\"></td>"
        + "<td style=\"background-color: #aaffaa; width: " + (100 - pctComplete) + "%\"></td>"
        + "</tr>"
        +  "</table>";
  }

  function shortHumanReadableElapsedTime(start, end) {
    function format(s) {
      return s.length == 1 ? "0" + s : s;
    }
    var elapsed = end - start;
    var sec = Math.round((elapsed / 1000) % 60);
    var min = Math.round((elapsed / 1000 / 60) % 60);
    var hrs = Math.round((elapsed / 1000 / 60 / 60));

    return format(hrs.toString()) + ":" + format(min.toString()) + ":" + format(sec.toString());
  }

  var project = "s2s_refresher";
  ${workflow_def}

  var liveworkflow = false;
  var shutdown_reason = "";
  ${live_workflow_def}

  var wfd = new Wfd(workflowSteps, workflowDatastores);
  var activeStep;
  var activeDatastore;
  var activeDetailsType = "step";
  for (i in wfd.getSortedSteps()) {
    var step = wfd.workflowDef[i];
    if (wfd.shouldBeIncluded(step.id)) {
      activeStep = step.id;
      break;
    }
  }
  for (i in wfd.getSortedDatastores()) {
    var ds = wfd.datastores[i];
    if (wfd.dsShouldBeIncluded(ds.name)) {
      activeDatastore = ds.name;
      break;
    }
  }

  function updateView() {
    renderDiagram("canvas", wfd);
    function updateProcessList() {
      var processListHtml = "";
      for (stepId in wfd.getSortedSteps()) {
        var step = wfd.workflowDef[stepId];
        if (wfd.shouldBeIncluded(step.id)) {
          var activeStr = activeStep == step.id && activeDetailsType == "step" ? " class='active'" : "";
          processListHtml += "<li" + activeStr + "><a id='process-" + step.id + "' href='#'> " + step.name + (step.status == "node" ? "" : " (" + step.status + ")") + "</a></li>"
        }
        $("#process-list").html(processListHtml);
        for (stepId in wfd.workflowDef) {
          var step = wfd.workflowDef[stepId];
          if (wfd.shouldBeIncluded(step.id)) {
            $("#process-" + step.id).click(
                (function (id) {
                  return function () {
                    activeStep = id;
                    activeDetailsType = "step";
                    updateView();
                  };
                })(step.id));
          }
        }
      }
    }

    function updateDatastoreList() {
      var datastoreListHtml = "";
      for (i in wfd.getSortedDatastores()) {
        var ds = wfd.datastores[i];
        if (wfd.dsShouldBeIncluded(ds.name)) {
          var activeStr = activeDatastore == ds.name && activeDetailsType == "datastore" ? " class='active'" : "";
          datastoreListHtml += "<li" + activeStr + "><a id='datastore-" + ds.name + "' href='#' > " + ds.name + "</a></li>"
        }
        $("#datastore-list").html(datastoreListHtml);
        for (i in wfd.datastores) {
          var ds = wfd.datastores[i];
          if (wfd.dsShouldBeIncluded(ds.name)) {
            $("#datastore-" + ds.name).click(
                (function (id) {
                  return function () {
                    activeDatastore = id;
                    activeDetailsType = "datastore";
                    updateView();
                  };
                })(ds.name));
          }
        }
      }
    }

    function updateStepDetails() {
      var step = wfd.idToStep[activeStep];
      $("#step-details-name").html(step.name);
      var project = step.java_class.split(".")[2];
      var path = step.java_class.replace(/\./g, "/");
      path += ".java";
      $("#step-details-action").html("<a target='_parent' href='https://git.liveramp.net/MasterRepos/" + project + "/tree/master/src/java/" + path + "'>" + step.java_class + "</a>");

      var detailsHtml = step.status;
      if (step.status == "running") {
        detailsHtml += renderProgressBar(step.pctComplete);
        detailsHtml += "Started at " + new Date(step.startTimestamp);
      } else if (step.status == "completed") {
        detailsHtml += "<br>Started at " + new Date(step.startTimestamp);
        detailsHtml += "<br>Ended at " + new Date(step.endTimestamp).toString();
        detailsHtml += "<br>Took " + shortHumanReadableElapsedTime(step.startTimestamp, step.endTimestamp);
      } else if (step.status == "node") {
        detailsHtml = "NA";
      }
      $("#step-details-status").html(detailsHtml);

      detailsHtml = "";
      var sorted = [];
      for (i in step.dependencies) {
        sorted.push(wfd.idToStep[step.dependencies[i]].name);
      }
      sorted.sort(function(s1, s2){return s1.toLowerCase() < s2.toLowerCase() ? -1 : (s1.toLowerCase() > s2.toLowerCase() ? 1 : 0)});
      for (i in sorted) {
        detailsHtml += "<ul><li>" + sorted[i] + "</ul></li>"
      }
      if (detailsHtml == "") detailsHtml = "NA";
      $("#step-details-dependencies").html(detailsHtml);

      detailsHtml = "";
      step.inputDatastores.sort(function(s1, s2){return s1.toLowerCase() < s2.toLowerCase() ? -1 : (s1.toLowerCase() > s2.toLowerCase() ? 1 : 0)});
      for (i in step.inputDatastores) {
        detailsHtml += "<ul><li>" + step.inputDatastores[i] + "</ul></li>"
      }
      if (detailsHtml == "") detailsHtml = "NA";
      $("#step-details-inputs").html(detailsHtml);

      detailsHtml = "";
      step.outputDatastores.sort(function(s1, s2){return s1.toLowerCase() < s2.toLowerCase() ? -1 : (s1.toLowerCase() > s2.toLowerCase() ? 1 : 0)});
      for (i in step.outputDatastores) {
        detailsHtml += "<ul><li>" + step.outputDatastores[i] + "</ul></li>"
      }
      if (detailsHtml == "") detailsHtml = "NA";
      $("#step-details-outputs").html(detailsHtml);
    }

    function updateDatastoreDetails() {
      var ds = wfd.nameToDatastore[activeDatastore];
      $("#ds-details-name").html(ds.name);
      $("#ds-details-type").html(ds.type);
      $("#ds-details-path").html("<a target='_parent' href='http://ds0208.rapleaf.com:50075/browseDirectory.jsp?dir=" + ds.path + "&namenodeInfoPort=50070'>" + ds.path + "</a>");
    }

    function updateShutwodnState() {
      if (liveworkflow) {
        if (shutdown_reason != "" ) {
          $("#shutdown-reason-area").html("<p>The workflow will shut down. Currently running components will be allowed to complete before exiting.</p><p>Reason: " + shutdown_reason + "</p>");
          $("#shutdown-reason-area").removeClass("hide");
        }
      } else {
        $("#shutdown-button").addClass("disabled");
        $("#shutdown-button").prop("href", "#")
      }
    }

    updateDatastoreList();
    updateProcessList();
    updateStepDetails();
    updateDatastoreDetails();
    updateShutwodnState();
    if (activeDetailsType == "step") {
      $("#step-details").show();
      $("#ds-details").hide();
    } else {
      $("#step-details").hide();
      $("#ds-details").show();
    }
  }

  $("#datastores").click(function() {
    if (wfd.includeDatastores == true) {
      wfd.includeDatastores = false;
      $("#datastores").html("Show Datastores");
    } else {
      wfd.includeDatastores = true;
      $("#datastores").html("Hide Datastores");
    }
    updateView();
  });

  $("#expand-all").click(function() {
    wfd.expandAll();
    updateView();
  });

  $("#collapse-all").click(function() {
    wfd.collapseAll();
    updateView();
  });

  window.onload = function () {
    updateView();
  };
</script>
</body>
</html>
